<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AXSerialPort: axserialport_example.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="axis-logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AXSerialPort
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('axserialport_example_8c-example.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">axserialport_example.c</div>  </div>
</div><!--header-->
<div class="contents">
<p><a class="el" href="axserialport_example_8c-example.html">axserialport_example.c</a></p>
<div class="fragment"><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * axserialport_example.c</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * An example application using the serialport API.</span></div><div class="line"><span class="comment"> * This example uses the GMainLoop.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Note! - This program requires a serial loopback</span></div><div class="line"><span class="comment"> *         cable in order to function properly.</span></div><div class="line"><span class="comment"> *         Rx _____  _____ Rx</span></div><div class="line"><span class="comment"> *                 \/</span></div><div class="line"><span class="comment"> *         Tx _____/\_____ Tx</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Copyright (C) 2013- Axis Communications AB, LUND, SWEDEN</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;syslog.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;glib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;axsdk/axserialport.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define APP_NAME &quot;SerialExample&quot;</span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Structure containing application configuration and data.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>MyConfigAndData {</div><div class="line">  <a class="code" href="axserialport_8h.html#a23ef70c577c96c2e3d362c5df67b9534">AXSerialConfig</a> *config;</div><div class="line">  GIOChannel *channel;</div><div class="line">  GTimer *timer;</div><div class="line">  gpointer data;</div><div class="line">} MyConfigAndData;</div><div class="line"></div><div class="line"><span class="keyword">static</span> GMainLoop *loop = NULL;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> handle_sigterm(<span class="keywordtype">int</span> signo);</div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> init_signals(<span class="keywordtype">void</span>);</div><div class="line"><span class="keyword">static</span> gchar *iostatus2str(GIOStatus status);</div><div class="line"><span class="keyword">static</span> gboolean incoming_data(GIOChannel *channel, GIOCondition cond, gpointer data);</div><div class="line"><span class="keyword">static</span> gboolean send_timer_data(gpointer data);</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Signal handling functions</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> handle_sigterm(<span class="keywordtype">int</span> signo)</div><div class="line">{</div><div class="line">  g_message(<span class="stringliteral">&quot;%s: Got SIGTERM&quot;</span>, APP_NAME);</div><div class="line">  g_main_loop_quit(loop);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> init_signals(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">  <span class="keyword">struct </span>sigaction sa;</div><div class="line">  sa.sa_flags = 0;</div><div class="line"></div><div class="line">  sigemptyset(&amp;sa.sa_mask);</div><div class="line">  sa.sa_handler = handle_sigterm;</div><div class="line">  sigaction(SIGTERM, &amp;sa, NULL);</div><div class="line">  sigaction(SIGINT, &amp;sa, NULL);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Converts a I/O status to a string</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> gchar *iostatus2str(GIOStatus status)</div><div class="line">{</div><div class="line">  <span class="keywordflow">switch</span> (status) {</div><div class="line">      <span class="keywordflow">case</span> G_IO_STATUS_ERROR:</div><div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&quot;G_IO_STATUS_ERROR&quot;</span>;</div><div class="line">      <span class="keywordflow">case</span> G_IO_STATUS_NORMAL:</div><div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&quot;G_IO_STATUS_NORMAL&quot;</span>;</div><div class="line">      <span class="keywordflow">case</span> G_IO_STATUS_EOF:</div><div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&quot;G_IO_STATUS_EOF&quot;</span>;</div><div class="line">      <span class="keywordflow">case</span> G_IO_STATUS_AGAIN:</div><div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&quot;G_IO_STATUS_AGAIN&quot;</span>;</div><div class="line">      <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&quot;Unknown GIOStatus!&quot;</span>;</div><div class="line">  }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Funtion to handle incomming serial data</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> gboolean</div><div class="line">incoming_data(GIOChannel *channel, GIOCondition cond, gpointer data)</div><div class="line">{</div><div class="line">  MyConfigAndData *conf_data = data;</div><div class="line">  GIOChannel *iochannel = conf_data-&gt;channel;</div><div class="line">  GError *error = NULL;</div><div class="line">  GIOStatus ret;</div><div class="line">  guint bytes_read;</div><div class="line">  gchar timestamp[2];</div><div class="line">  gchar str[128];</div><div class="line"></div><div class="line">  <span class="comment">/* We have incoming data, read it! */</span></div><div class="line">  ret = g_io_channel_read_chars(iochannel, timestamp, <span class="keyword">sizeof</span>(timestamp),</div><div class="line">                                &amp;bytes_read, &amp;error);</div><div class="line">  <span class="keywordflow">if</span> (ret == G_IO_STATUS_NORMAL) {</div><div class="line">    <span class="comment">/* All OK! write the timestamp to stdout and syslog */</span></div><div class="line">    guchar min = timestamp[0];</div><div class="line">    guchar sec = timestamp[1];</div><div class="line">    g_snprintf(str, 128, <span class="stringliteral">&quot;%s() timestamp: %02u:%02u&quot;</span>, __FUNCTION__, min, sec);</div><div class="line">    g_message(<span class="stringliteral">&quot;%s&quot;</span>, str);</div><div class="line">    syslog(LOG_INFO, <span class="stringliteral">&quot;%s&quot;</span>, str);</div><div class="line">  } <span class="keywordflow">else</span> {</div><div class="line">    g_message(<span class="stringliteral">&quot;%s: error :&quot;</span>, APP_NAME);</div><div class="line">    <span class="keywordflow">if</span> (error) {                <span class="comment">/* Report error */</span></div><div class="line">      g_message(<span class="stringliteral">&quot;%s&quot;</span>, error-&gt;message);</div><div class="line">      syslog(LOG_ERR, <span class="stringliteral">&quot;%s&quot;</span>, error-&gt;message);</div><div class="line">      g_error_free(error);      <span class="comment">/* free error */</span></div><div class="line">    }</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">/* Return FALSE if the event source should be removed */</span></div><div class="line">  <span class="keywordflow">return</span> TRUE;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Function that send out a two byte timestamp on the serial port.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> gboolean send_timer_data(gpointer data)</div><div class="line">{</div><div class="line">  MyConfigAndData *conf_data = data;</div><div class="line">  GIOChannel *iochannel = conf_data-&gt;channel;</div><div class="line">  GTimer *timer = conf_data-&gt;timer;</div><div class="line">  GError *error = NULL;</div><div class="line">  GIOStatus ret;</div><div class="line">  gdouble elapsed;</div><div class="line">  gchar min, sec;</div><div class="line">  guint bytes_written;</div><div class="line">  gchar timestamp[2];</div><div class="line"></div><div class="line">  <span class="comment">/* time in seconds since timer started */</span></div><div class="line">  elapsed = g_timer_elapsed(timer, NULL);</div><div class="line">  min = elapsed / 60;           <span class="comment">/* Wraps 256-&gt;0 */</span></div><div class="line">  sec = ((guint) elapsed) % 60;</div><div class="line">  timestamp[0] = min;</div><div class="line">  timestamp[1] = sec;</div><div class="line"></div><div class="line">  ret = g_io_channel_write_chars(iochannel, timestamp, <span class="keyword">sizeof</span>(timestamp),</div><div class="line">                                 &amp;bytes_written, &amp;error);</div><div class="line">  <span class="keywordflow">if</span> (ret == G_IO_STATUS_NORMAL) {</div><div class="line">    <span class="comment">/* Flush the write buffer */</span></div><div class="line">    ret = g_io_channel_flush(iochannel, &amp;error);</div><div class="line">    <span class="comment">/* Log the return status from g_io_channel_write_chars() */</span></div><div class="line">    g_message(<span class="stringliteral">&quot;%s() wrote %d bytes, status:&#39;%s&#39;&quot;</span>,</div><div class="line">              __FUNCTION__, bytes_written, iostatus2str(ret));</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keywordflow">if</span> (error) {                  <span class="comment">/* Report to stderr and syslog */</span></div><div class="line">    g_message(<span class="stringliteral">&quot;%s&quot;</span>, error-&gt;message);</div><div class="line">    syslog(LOG_ERR, <span class="stringliteral">&quot;%s&quot;</span>, error-&gt;message);</div><div class="line">    g_error_free(error);        <span class="comment">/* free error */</span></div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">/* Return FALSE if the event source should be removed */</span></div><div class="line">  <span class="keywordflow">return</span> TRUE;</div><div class="line">}</div><div class="line"></div><div class="line"> <span class="comment">/*</span></div><div class="line"><span class="comment">  *  Our main function</span></div><div class="line"><span class="comment">  */</span></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div><div class="line">{</div><div class="line">  gint fd = 0;</div><div class="line">  gint ret = 0;</div><div class="line">  gint status = EXIT_FAILURE;</div><div class="line">  guint port0 = 0;</div><div class="line">  <a class="code" href="axserialport_8h.html#a23ef70c577c96c2e3d362c5df67b9534">AXSerialConfig</a> *config = NULL;</div><div class="line">  GIOChannel *iochannel = NULL;</div><div class="line">  GError *error = NULL;</div><div class="line">  MyConfigAndData conf_data;</div><div class="line"></div><div class="line">  <span class="comment">/* Initialization */</span></div><div class="line">  init_signals();</div><div class="line">  loop = g_main_loop_new(NULL, FALSE);</div><div class="line"></div><div class="line">  <span class="comment">/* Print some startup messages */</span></div><div class="line">  g_message(<span class="stringliteral">&quot;%s: Starting!&quot;</span>, APP_NAME);</div><div class="line">  openlog(APP_NAME, LOG_PID, LOG_LOCAL4);</div><div class="line">  syslog(LOG_INFO, <span class="stringliteral">&quot;Starting!&quot;</span>);</div><div class="line"></div><div class="line">  <span class="comment">/* Create a configuration for the first port (port0) */</span></div><div class="line">  config = <a name="a0"></a><a class="code" href="axserialport_8h.html#a7853bbb05efc56ae327c15be5bc68fa1">ax_serial_init</a>(port0, &amp;error);</div><div class="line">  <span class="keywordflow">if</span> (!config) {</div><div class="line">    <span class="keywordflow">goto</span> error_out;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">/* Config example (product dependent) see product datasheet.</span></div><div class="line"><span class="comment">   * Enable Port, RS485 4-Wire, Baudrate 19200, 8 Databits,</span></div><div class="line"><span class="comment">   * 1 Stopbit, No Termination, No Bias */</span></div><div class="line">  <a name="a1"></a><a class="code" href="axserialport_8h.html#ad234f3601069158c95818e95e58c103e">ax_serial_port_enable</a>(config, <a name="a2"></a><a class="code" href="axserialport_8h.html#aa5b997bede5f227da2972cb68b7b019fa9d160b4fc03889a608676c545949263a">AX_SERIAL_ENABLE</a>, NULL);</div><div class="line">  <a name="a3"></a><a class="code" href="axserialport_8h.html#a12b99a362414e53fc028dfc158217793">ax_serial_set_portmode</a>(config, <a name="a4"></a><a class="code" href="axserialport_8h.html#a9044e5cb88fa2f3c590e0cfed522180da4c8a981234bcbf6f0dd6f9261359bcb4">AX_SERIAL_RS485_4</a>, NULL);</div><div class="line">  <a name="a5"></a><a class="code" href="axserialport_8h.html#a4a0d583419285dd6f49526eb3f0efbbd">ax_serial_set_baudrate</a>(config, <a name="a6"></a><a class="code" href="axserialport_8h.html#ac577bb83504ff075f9b35ed168859ff5ab5c6859901d9a739a0838964d766e01c">AX_SERIAL_B19200</a>, NULL);</div><div class="line">  <a name="a7"></a><a class="code" href="axserialport_8h.html#aef4e3cb70b99f2ed69103396b1755b94">ax_serial_set_databits</a>(config, <a name="a8"></a><a class="code" href="axserialport_8h.html#a17a9de82d354beebb6a987cd73ae22f9acb1abda53eeae8373045f033561e8852">AX_SERIAL_DATABITS_8</a>, NULL);</div><div class="line">  <a name="a9"></a><a class="code" href="axserialport_8h.html#a9218c4fee3f2e1bde757b33808e2e033">ax_serial_set_stopbits</a>(config, <a name="a10"></a><a class="code" href="axserialport_8h.html#a1f885f1948816a1dff6bb910519781afa75fd6c95470505110884ac3bdf4335f7">AX_SERIAL_STOPBITS_1</a>, NULL);</div><div class="line">  <a name="a11"></a><a class="code" href="axserialport_8h.html#a844e6cce32d0e7b8148e2bbc9749f28f">ax_serial_set_termination</a>(config, <a name="a12"></a><a class="code" href="axserialport_8h.html#aa5b997bede5f227da2972cb68b7b019fa655305e708c86b562b2b60511a521e41">AX_SERIAL_DISABLE</a>, NULL);</div><div class="line">  <a name="a13"></a><a class="code" href="axserialport_8h.html#a48b17a8568a52e5b1c0cb6ab5989f843">ax_serial_set_bias</a>(config, <a class="code" href="axserialport_8h.html#aa5b997bede5f227da2972cb68b7b019fa655305e708c86b562b2b60511a521e41">AX_SERIAL_DISABLE</a>, NULL);</div><div class="line"></div><div class="line">  <span class="comment">/* Syncronize (set) configuration */</span></div><div class="line">  ret = <a name="a14"></a><a class="code" href="axserialport_8h.html#aae31751b7ca03c21d258efeec4d2640b">ax_serial_sync_port_settings</a>(config, &amp;error);</div><div class="line">  <span class="keywordflow">if</span> (!ret) {</div><div class="line">    <span class="keywordflow">goto</span> error_out;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">/* Get the file descriptor associated with the configured port. */</span></div><div class="line">  fd = <a name="a15"></a><a class="code" href="axserialport_8h.html#a82f716ddc30b9960a3f7608e7d3f3bac">ax_serial_get_fd</a>(config, &amp;error);</div><div class="line">  <span class="keywordflow">if</span> (fd &lt; 0) {</div><div class="line">    <span class="keywordflow">goto</span> error_out;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">/* Create a GIOChannel from the fd */</span></div><div class="line">  iochannel = g_io_channel_unix_new(fd);</div><div class="line">  <span class="keywordflow">if</span> (!iochannel) {</div><div class="line">    <span class="keywordflow">goto</span> error_out;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">/* Set IO Channel encoding to RAW (default is UTF-8) */</span></div><div class="line">  <span class="keywordflow">if</span> (G_IO_STATUS_NORMAL != g_io_channel_set_encoding(iochannel, NULL, &amp;error)) {</div><div class="line">    <span class="keywordflow">goto</span> error_out;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">/* Prepare the conf_data structure */</span></div><div class="line">  conf_data.config  = config;</div><div class="line">  conf_data.channel = iochannel;</div><div class="line">  conf_data.timer   = g_timer_new(); <span class="comment">/* Create and start a timer */</span></div><div class="line"></div><div class="line">  <span class="comment">/* Add a watch that waits for incoming data, then calls &#39;incoming_data()&#39;</span></div><div class="line"><span class="comment">   * when the conditions are met. */</span></div><div class="line">  g_io_add_watch(iochannel,     <span class="comment">/* GIOChannel */</span></div><div class="line">                 G_IO_IN,       <span class="comment">/* GIOCondition: On incoming data */</span></div><div class="line">                 incoming_data, <span class="comment">/* The function to be called */</span></div><div class="line">                 &amp;conf_data     <span class="comment">/* Data to pass to function */</span></div><div class="line">      );</div><div class="line"></div><div class="line">  <span class="comment">/* Periodically call &#39;send_timer_data()&#39; every 2nd second */</span></div><div class="line">  g_timeout_add(2000, send_timer_data, &amp;conf_data);</div><div class="line"></div><div class="line">  <span class="comment">/* start the main loop */</span></div><div class="line">  g_main_loop_run(loop);</div><div class="line"></div><div class="line">  <span class="comment">/* unref the main loop when the main loop has been quit */</span></div><div class="line">  g_main_loop_unref(loop);</div><div class="line"></div><div class="line">  status = EXIT_SUCCESS;</div><div class="line"></div><div class="line"> error_out:</div><div class="line">  <span class="keywordflow">if</span> (error) {</div><div class="line">    <span class="comment">/* Report error */</span></div><div class="line">    g_critical(<span class="stringliteral">&quot;%s&quot;</span>, error-&gt;message);</div><div class="line">    syslog(LOG_ERR, <span class="stringliteral">&quot;%s&quot;</span>, error-&gt;message);</div><div class="line">    <span class="comment">/* free error */</span></div><div class="line">    g_error_free(error);</div><div class="line">    status = EXIT_FAILURE;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">/* close the iochannels, no flush */</span></div><div class="line">  <span class="keywordflow">if</span> (iochannel != NULL) {</div><div class="line">    g_io_channel_shutdown(iochannel, FALSE, NULL);</div><div class="line">    g_io_channel_unref(iochannel);</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">/* clean up and exit */</span></div><div class="line">  <a name="a16"></a><a class="code" href="axserialport_8h.html#a896f7ee99077fa5dd99ab5835d965e0a">ax_serial_cleanup</a>(config);</div><div class="line">  syslog(LOG_INFO, <span class="stringliteral">&quot;Bye!&quot;</span>);</div><div class="line">  g_message(<span class="stringliteral">&quot;%s: bye!&quot;</span>, APP_NAME);</div><div class="line"></div><div class="line">  exit(status);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* EOF */</span></div></div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Copyright &copy; 2009-2022 Axis Communications AB. All rights reserved.</li>
  </ul>
</div>
</body>
</html>
