<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AXStorage: ax_storage_example.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="axis-logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AXStorage
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('ax_storage_example_8c-example.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">ax_storage_example.c</div>  </div>
</div><!--header-->
<div class="contents">
<p><a class="el" href="ax_storage_example_8c-example.html">ax_storage_example.c</a></p>
<div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;signal.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;glib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;glib/gstdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;syslog.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div><div class="line"></div><div class="line"><span class="comment">/* AX Storage library. */</span></div><div class="line"><span class="preprocessor">#include &lt;axsdk/axstorage.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define APP_NAME &quot;axStorageExample&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div><div class="line">  <a class="code" href="ax__storage_8h.html#aa14f17bf10b2dcc57d1ca16759da9b8f">AXStorage</a> *storage; </div><div class="line">  <a class="code" href="ax__storage_8h.html#a7ddcacc73d86ef686018ed8725535a51">AXStorageType</a> storage_type; </div><div class="line">  gchar *storage_id; </div><div class="line">  gchar *storage_path; </div><div class="line">  guint subscription_id; </div><div class="line">  gboolean setup; </div><div class="line">  gboolean writable; </div><div class="line">  gboolean available; </div><div class="line">  gboolean full; </div><div class="line">  gboolean exiting; </div><div class="line">} disk_item_t;</div><div class="line"></div><div class="line"><span class="keyword">static</span> GList *disks_list = NULL;</div><div class="line"><span class="keyword">static</span> GMainLoop *loop = NULL;</div><div class="line"></div><div class="line"><span class="comment">/* Signals */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line">handle_sigterm(<span class="keywordtype">int</span> signo)</div><div class="line">{</div><div class="line">  <span class="keywordflow">if</span> (loop != NULL) {</div><div class="line">    g_main_loop_quit(loop);</div><div class="line">  } <span class="keywordflow">else</span> {</div><div class="line">    exit(EXIT_FAILURE);</div><div class="line">  }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line">init_signals(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">  <span class="keyword">struct </span>sigaction sa;</div><div class="line"></div><div class="line">  sa.sa_flags = 0;</div><div class="line"></div><div class="line">  sigemptyset(&amp;sa.sa_mask);</div><div class="line">  sa.sa_handler = handle_sigterm;</div><div class="line">  sigaction(SIGTERM, &amp;sa, NULL);</div><div class="line">  sigaction(SIGINT, &amp;sa, NULL);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> gboolean</div><div class="line">write_data(<span class="keyword">const</span> gchar *data)</div><div class="line">{</div><div class="line">  <span class="keyword">static</span> guint counter = 0;</div><div class="line">  GList *node = NULL;</div><div class="line">  gboolean ret = TRUE;</div><div class="line">  <span class="keywordflow">for</span> (node = g_list_first(disks_list); node != NULL;</div><div class="line">       node = g_list_next(node)) {</div><div class="line"></div><div class="line">    disk_item_t *item = node-&gt;data;</div><div class="line"></div><div class="line">    <span class="comment">/* Write data to disk when it is available, writable and has disk space</span></div><div class="line"><span class="comment">       and the setup has been done. */</span></div><div class="line">    <span class="keywordflow">if</span> (item-&gt;available &amp;&amp; item-&gt;writable &amp;&amp; !item-&gt;full &amp;&amp; item-&gt;setup) {</div><div class="line">      gchar *filename = g_strdup_printf(<span class="stringliteral">&quot;%s/%s.log&quot;</span>, item-&gt;storage_path,</div><div class="line">          data);</div><div class="line"></div><div class="line">      FILE *file = g_fopen(filename, <span class="stringliteral">&quot;a&quot;</span>);</div><div class="line">      <span class="keywordflow">if</span> (file == NULL) {</div><div class="line">        syslog(LOG_WARNING, <span class="stringliteral">&quot;Failed to open %s. Error %s.&quot;</span>, filename,</div><div class="line">            g_strerror(errno));</div><div class="line">        ret = FALSE;</div><div class="line">      } <span class="keywordflow">else</span> {</div><div class="line">        g_fprintf(file, <span class="stringliteral">&quot;counter: %d\n&quot;</span>, ++counter);</div><div class="line">        fclose(file);</div><div class="line">      }</div><div class="line">      g_free(filename);</div><div class="line">    }</div><div class="line">  }</div><div class="line">  <span class="keywordflow">return</span> ret;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">static</span> disk_item_t *</div><div class="line">find_disk_item_t(gchar *storage_id)</div><div class="line">{</div><div class="line">  GList *node = NULL;</div><div class="line">  disk_item_t *item = NULL;</div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (node = g_list_first(disks_list); node != NULL;</div><div class="line">       node = g_list_next(node)) {</div><div class="line"></div><div class="line">    item = node-&gt;data;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (g_strcmp0(storage_id, item-&gt;storage_id) == 0) {</div><div class="line">      <span class="keywordflow">return</span> item;</div><div class="line">    }</div><div class="line">  }</div><div class="line">  <span class="keywordflow">return</span> NULL;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line">release_disk_cb(gpointer user_data, GError *error)</div><div class="line">{</div><div class="line">  syslog(LOG_INFO, <span class="stringliteral">&quot;Release of %s&quot;</span>, (gchar*) user_data);</div><div class="line">  <span class="keywordflow">if</span> (error != NULL) {</div><div class="line">    syslog(LOG_WARNING, <span class="stringliteral">&quot;Error while releasing %s: %s&quot;</span>, (gchar*) user_data,</div><div class="line">        error-&gt;message);</div><div class="line">    g_error_free(error);</div><div class="line">  }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line">free_disk_item_t()</div><div class="line">{</div><div class="line">  GList *node = NULL;</div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (node = g_list_first(disks_list); node != NULL;</div><div class="line">       node = g_list_next(node)) {</div><div class="line"></div><div class="line">    GError *error = NULL;</div><div class="line">    disk_item_t *item = node-&gt;data;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (item-&gt;setup) {</div><div class="line">      <span class="comment">/* NOTE: It is advised to finish all your reading/writing operations</span></div><div class="line"><span class="comment">         before releasing the storage device. */</span></div><div class="line">      <a name="a0"></a><a class="code" href="ax__storage_8h.html#a27909ecc692b78af43ce23bf0369fe95">ax_storage_release_async</a>(item-&gt;storage, release_disk_cb,</div><div class="line">          item-&gt;storage_id, &amp;error);</div><div class="line">      <span class="keywordflow">if</span> (error != NULL) {</div><div class="line">        syslog(LOG_WARNING, <span class="stringliteral">&quot;Failed to release %s. Error: %s&quot;</span>,</div><div class="line">            item-&gt;storage_id, error-&gt;message);</div><div class="line">        g_clear_error(&amp;error);</div><div class="line">      } <span class="keywordflow">else</span> {</div><div class="line">        syslog(LOG_INFO, <span class="stringliteral">&quot;Release of %s was successful&quot;</span>, item-&gt;storage_id);</div><div class="line">        item-&gt;setup = FALSE;</div><div class="line">      }</div><div class="line">    }</div><div class="line"></div><div class="line">    <a name="a1"></a><a class="code" href="ax__storage_8h.html#a49676a4baae47e9407f3641fefcd365c">ax_storage_unsubscribe</a>(item-&gt;subscription_id, &amp;error);</div><div class="line">    <span class="keywordflow">if</span> (error != NULL) {</div><div class="line">      syslog(LOG_WARNING, <span class="stringliteral">&quot;Failed to unsubscribe event of %s. Error: %s&quot;</span>,</div><div class="line">          item-&gt;storage_id, error-&gt;message);</div><div class="line">      g_clear_error(&amp;error);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">      syslog(LOG_INFO, <span class="stringliteral">&quot;Unsubscribed events of %s&quot;</span>, item-&gt;storage_id);</div><div class="line">    }</div><div class="line">    g_free(item-&gt;storage_id);</div><div class="line">    g_free(item-&gt;storage_path);</div><div class="line">  }</div><div class="line">  g_list_free(disks_list);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line">setup_disk_cb(<a class="code" href="ax__storage_8h.html#aa14f17bf10b2dcc57d1ca16759da9b8f">AXStorage</a> *storage, gpointer user_data, GError *error)</div><div class="line">{</div><div class="line">  GError *ax_error = NULL;</div><div class="line">  gchar *storage_id = NULL;</div><div class="line">  gchar *path = NULL;</div><div class="line">  <a class="code" href="ax__storage_8h.html#a7ddcacc73d86ef686018ed8725535a51">AXStorageType</a> storage_type;</div><div class="line"></div><div class="line">  <span class="keywordflow">if</span> (storage == NULL || error != NULL) {</div><div class="line">    syslog(LOG_ERR, <span class="stringliteral">&quot;Failed to setup disk. Error: %s&quot;</span>, error-&gt;message);</div><div class="line">    g_error_free(error);</div><div class="line">    <span class="keywordflow">goto</span> free_variables;</div><div class="line">  }</div><div class="line"></div><div class="line">  storage_id = <a name="a2"></a><a class="code" href="ax__storage_8h.html#a3641678e98f8f23ce25e17f8b10f8f6d">ax_storage_get_storage_id</a>(storage, &amp;ax_error);</div><div class="line">  <span class="keywordflow">if</span> (ax_error != NULL) {</div><div class="line">    syslog(LOG_WARNING, <span class="stringliteral">&quot;Failed to get storage_id. Error: %s&quot;</span>,</div><div class="line">        ax_error-&gt;message);</div><div class="line">    g_error_free(ax_error);</div><div class="line">    <span class="keywordflow">goto</span> free_variables;</div><div class="line">  }</div><div class="line"></div><div class="line">  path = <a name="a3"></a><a class="code" href="ax__storage_8h.html#a821ec183a5d9aa227a1f7aaf34490f42">ax_storage_get_path</a>(storage, &amp;ax_error);</div><div class="line">  <span class="keywordflow">if</span> (ax_error != NULL) {</div><div class="line">    syslog(LOG_WARNING, <span class="stringliteral">&quot;Failed to get storage path. Error: %s&quot;</span>,</div><div class="line">        ax_error-&gt;message);</div><div class="line">    g_error_free(ax_error);</div><div class="line">    <span class="keywordflow">goto</span> free_variables;</div><div class="line">  }</div><div class="line"></div><div class="line">  storage_type = <a name="a4"></a><a class="code" href="ax__storage_8h.html#a9466aecbb946b9d5a0701733cebaff93">ax_storage_get_type</a>(storage, &amp;ax_error);</div><div class="line">  <span class="keywordflow">if</span> (ax_error != NULL) {</div><div class="line">    syslog(LOG_WARNING, <span class="stringliteral">&quot;Failed to get storage type. Error: %s&quot;</span>,</div><div class="line">        ax_error-&gt;message);</div><div class="line">    g_error_free(ax_error);</div><div class="line">    <span class="keywordflow">goto</span> free_variables;</div><div class="line">  }</div><div class="line"></div><div class="line">  disk_item_t *disk = find_disk_item_t(storage_id);</div><div class="line">  <span class="comment">/* The storage pointer is created in this callback, assign it to</span></div><div class="line"><span class="comment">     disk_item_t instance. */</span></div><div class="line">  disk-&gt;storage = storage;</div><div class="line">  disk-&gt;storage_type = storage_type;</div><div class="line">  disk-&gt;storage_path = g_strdup(path);</div><div class="line">  disk-&gt;setup = TRUE;</div><div class="line"></div><div class="line">  syslog(LOG_INFO, <span class="stringliteral">&quot;Disk: %s has been setup in %s&quot;</span>, storage_id, path);</div><div class="line">free_variables:</div><div class="line">  g_free(storage_id);</div><div class="line">  g_free(path);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line">subscribe_cb(gchar *storage_id, gpointer user_data, GError *error)</div><div class="line">{</div><div class="line">  GError *ax_error = NULL;</div><div class="line">  gboolean available;</div><div class="line">  gboolean writable;</div><div class="line">  gboolean full;</div><div class="line">  gboolean exiting;</div><div class="line"></div><div class="line">  <span class="keywordflow">if</span> (error != NULL) {</div><div class="line">    syslog(LOG_WARNING, <span class="stringliteral">&quot;Failed to subscribe to %s. Error: %s&quot;</span>, storage_id,</div><div class="line">        error-&gt;message);</div><div class="line">    g_error_free(error);</div><div class="line">    <span class="keywordflow">return</span>;</div><div class="line">  }</div><div class="line"></div><div class="line">  syslog(LOG_INFO, <span class="stringliteral">&quot;Subscribe for the events of %s&quot;</span>, storage_id);</div><div class="line">  disk_item_t *disk = find_disk_item_t(storage_id);</div><div class="line"></div><div class="line">  <span class="comment">/* Get the status of the events. */</span></div><div class="line">  exiting = <a name="a5"></a><a class="code" href="ax__storage_8h.html#ab9e6508ae1fbdf1b4a799763cc6546da">ax_storage_get_status</a>(storage_id, <a name="a6"></a><a class="code" href="ax__storage_8h.html#a24a6342f43a2463681f58f282cbf41a2a8189128989618bf40ef9ba491392ba61">AX_STORAGE_EXITING_EVENT</a>,</div><div class="line">      &amp;ax_error);</div><div class="line">  <span class="keywordflow">if</span> (ax_error != NULL) {</div><div class="line">    syslog(LOG_WARNING, <span class="stringliteral">&quot;Failed to get EXITING event for %s. Error: %s&quot;</span>,</div><div class="line">        storage_id, ax_error-&gt;message);</div><div class="line">    g_error_free(ax_error);</div><div class="line">    <span class="keywordflow">return</span>;</div><div class="line">  }</div><div class="line"></div><div class="line">  available = <a class="code" href="ax__storage_8h.html#ab9e6508ae1fbdf1b4a799763cc6546da">ax_storage_get_status</a>(storage_id, <a name="a7"></a><a class="code" href="ax__storage_8h.html#a24a6342f43a2463681f58f282cbf41a2a1a18cd0f92f18da4942daf6b9148dca5">AX_STORAGE_AVAILABLE_EVENT</a>,</div><div class="line">      &amp;ax_error);</div><div class="line">  <span class="keywordflow">if</span> (ax_error != NULL) {</div><div class="line">    syslog(LOG_WARNING, <span class="stringliteral">&quot;Failed to get AVAILABLE event for %s. Error: %s&quot;</span>,</div><div class="line">        storage_id, ax_error-&gt;message);</div><div class="line">    g_error_free(ax_error);</div><div class="line">    <span class="keywordflow">return</span>;</div><div class="line">  }</div><div class="line"></div><div class="line">  writable = <a class="code" href="ax__storage_8h.html#ab9e6508ae1fbdf1b4a799763cc6546da">ax_storage_get_status</a>(storage_id, <a name="a8"></a><a class="code" href="ax__storage_8h.html#a24a6342f43a2463681f58f282cbf41a2adecc4258ba5f99a81dcda0d28df71894">AX_STORAGE_WRITABLE_EVENT</a>,</div><div class="line">      &amp;ax_error);</div><div class="line">  <span class="keywordflow">if</span> (ax_error != NULL) {</div><div class="line">    syslog(LOG_WARNING, <span class="stringliteral">&quot;Failed to get WRITABLE event for %s. Error: %s&quot;</span>,</div><div class="line">        storage_id, ax_error-&gt;message);</div><div class="line">    g_error_free(ax_error);</div><div class="line">    <span class="keywordflow">return</span>;</div><div class="line">  }</div><div class="line"></div><div class="line">  full = <a class="code" href="ax__storage_8h.html#ab9e6508ae1fbdf1b4a799763cc6546da">ax_storage_get_status</a>(storage_id, <a name="a9"></a><a class="code" href="ax__storage_8h.html#a24a6342f43a2463681f58f282cbf41a2a305d2493c1c63afbec9ccf9733ce3cfa">AX_STORAGE_FULL_EVENT</a>, &amp;ax_error);</div><div class="line">  <span class="keywordflow">if</span> (ax_error != NULL) {</div><div class="line">    syslog(LOG_WARNING, <span class="stringliteral">&quot;Failed to get FULL event for %s. Error: %s&quot;</span>,</div><div class="line">        storage_id, ax_error-&gt;message);</div><div class="line">    g_error_free(ax_error);</div><div class="line">    <span class="keywordflow">return</span>;</div><div class="line">  }</div><div class="line"></div><div class="line">  disk-&gt;writable = writable;</div><div class="line">  disk-&gt;available = available;</div><div class="line">  disk-&gt;exiting = exiting;</div><div class="line">  disk-&gt;full = full;</div><div class="line"></div><div class="line">  <span class="comment">/* If exiting, and the disk was set up before, release it. */</span></div><div class="line">  <span class="keywordflow">if</span> (exiting &amp;&amp; disk-&gt;setup) {</div><div class="line">    <span class="comment">/* NOTE: It is advised to finish all your reading/writing operations before</span></div><div class="line"><span class="comment">       releasing the storage device. */</span></div><div class="line">    <a class="code" href="ax__storage_8h.html#a27909ecc692b78af43ce23bf0369fe95">ax_storage_release_async</a>(disk-&gt;storage, release_disk_cb, storage_id,</div><div class="line">        &amp;ax_error);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (ax_error != NULL) {</div><div class="line">      syslog(LOG_WARNING, <span class="stringliteral">&quot;Failed to release %s. Error %s.&quot;</span>, storage_id,</div><div class="line">          ax_error-&gt;message);</div><div class="line">      g_error_free(ax_error);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">      syslog(LOG_INFO, <span class="stringliteral">&quot;Release of %s was successful&quot;</span>, storage_id);</div><div class="line">      disk-&gt;setup = FALSE;</div><div class="line">    }</div><div class="line"></div><div class="line">  <span class="comment">/* Writable implies that the disk is available. */</span></div><div class="line">  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (writable &amp;&amp; !full &amp;&amp; !exiting &amp;&amp; !disk-&gt;setup) {</div><div class="line">    syslog(LOG_INFO, <span class="stringliteral">&quot;Setup %s&quot;</span>, storage_id);</div><div class="line">    <a name="a10"></a><a class="code" href="ax__storage_8h.html#abb7bf1c1cab1961dc4c2fffedaaa73cd">ax_storage_setup_async</a>(storage_id, setup_disk_cb, NULL, &amp;ax_error);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (ax_error != NULL) {</div><div class="line">      <span class="comment">/* NOTE: It is advised to try to setup again in case of failure. */</span></div><div class="line">      syslog(LOG_WARNING, <span class="stringliteral">&quot;Failed to setup %s, reason: %s&quot;</span>, storage_id,</div><div class="line">          ax_error-&gt;message);</div><div class="line">      g_error_free(ax_error);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">      syslog(LOG_INFO, <span class="stringliteral">&quot;Setup of %s was successful&quot;</span>, storage_id);</div><div class="line">    }</div><div class="line">  }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> disk_item_t *</div><div class="line">new_disk_item_t(gchar *storage_id)</div><div class="line">{</div><div class="line">  GError *error = NULL;</div><div class="line">  disk_item_t *item = NULL;</div><div class="line">  guint subscription_id;</div><div class="line"></div><div class="line">  <span class="comment">/* Subscribe to disks events. */</span></div><div class="line">  subscription_id = <a name="a11"></a><a class="code" href="ax__storage_8h.html#ae64f800e6d88b54cf68cce925bb16312">ax_storage_subscribe</a>(storage_id, subscribe_cb, NULL,</div><div class="line">      &amp;error);</div><div class="line">  <span class="keywordflow">if</span> (subscription_id == 0 || error != NULL) {</div><div class="line">    syslog(LOG_ERR, <span class="stringliteral">&quot;Failed to subscribe to events of %s. Error: %s&quot;</span>,</div><div class="line">        storage_id, error-&gt;message);</div><div class="line">    g_clear_error(&amp;error);</div><div class="line">    <span class="keywordflow">return</span> NULL;</div><div class="line">  }</div><div class="line"></div><div class="line">  item = g_new0(disk_item_t, 1);</div><div class="line">  item-&gt;subscription_id = subscription_id;</div><div class="line">  item-&gt;storage_id = g_strdup(storage_id);</div><div class="line">  item-&gt;setup = FALSE;</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> item;</div><div class="line">}</div><div class="line"></div><div class="line">gint</div><div class="line">main()</div><div class="line">{</div><div class="line">  GList *disks = NULL;</div><div class="line">  GList *node = NULL;</div><div class="line">  GError *error = NULL;</div><div class="line">  gint ret = EXIT_SUCCESS;</div><div class="line"></div><div class="line">  init_signals();</div><div class="line">  openlog(APP_NAME, LOG_PID, LOG_LOCAL4);</div><div class="line">  syslog(LOG_INFO, <span class="stringliteral">&quot;Start AXStorage application.&quot;</span>);</div><div class="line"></div><div class="line">  disks = <a name="a12"></a><a class="code" href="ax__storage_8h.html#aa32bdb91706c44a86071c1c14889536f">ax_storage_list</a>(&amp;error);</div><div class="line">  <span class="keywordflow">if</span> (error != NULL) {</div><div class="line">    syslog(LOG_WARNING, <span class="stringliteral">&quot;Failed to list storage devices. Error: (%s)&quot;</span>,</div><div class="line">        error-&gt;message);</div><div class="line">    g_error_free(error);</div><div class="line">    ret = EXIT_FAILURE;</div><div class="line">    <span class="comment">/* Note: It is advised to get the list more than once, in case of failure.*/</span></div><div class="line">    <span class="keywordflow">goto</span> out;</div><div class="line">  }</div><div class="line"></div><div class="line">  loop = g_main_loop_new(NULL, FALSE);</div><div class="line"></div><div class="line">  <span class="comment">/* Loop through the retrieved disks and subscribe to their events. */</span></div><div class="line">  <span class="keywordflow">for</span> (node = g_list_first(disks); node != NULL; node = g_list_next(node)) {</div><div class="line">    gchar *disk_name = (gchar *) node-&gt;data;</div><div class="line">    disk_item_t *item = new_disk_item_t(disk_name);</div><div class="line">    <span class="keywordflow">if</span> (item == NULL) {</div><div class="line">      syslog(LOG_WARNING, <span class="stringliteral">&quot;%s is skipped&quot;</span>, disk_name);</div><div class="line">      g_free(node-&gt;data);</div><div class="line">      <span class="keywordflow">continue</span>;</div><div class="line">    }</div><div class="line">    disks_list = g_list_append(disks_list, item);</div><div class="line">    g_free(node-&gt;data);</div><div class="line">  }</div><div class="line">  g_list_free(disks);</div><div class="line"></div><div class="line">  <span class="comment">/* Write contents to two files. */</span></div><div class="line">  gchar *file1 = g_strdup(<span class="stringliteral">&quot;file1&quot;</span>);</div><div class="line">  gchar *file2 = g_strdup(<span class="stringliteral">&quot;file2&quot;</span>);</div><div class="line">  g_timeout_add(1000, (GSourceFunc) write_data, file1);</div><div class="line">  g_timeout_add(1000, (GSourceFunc) write_data, file2);</div><div class="line"></div><div class="line">  <span class="comment">/* start the main loop */</span></div><div class="line">  g_main_loop_run(loop);</div><div class="line"></div><div class="line">  free_disk_item_t();</div><div class="line">  g_free(file1);</div><div class="line">  g_free(file2);</div><div class="line">  <span class="comment">/* unref the main loop when the main loop has been quit */</span></div><div class="line">  g_main_loop_unref(loop);</div><div class="line">out:</div><div class="line">  syslog(LOG_INFO, <span class="stringliteral">&quot;Finish AXStorage application.&quot;</span>);</div><div class="line">  <span class="keywordflow">return</span> ret;</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Copyright &copy; 2009-2022 Axis Communications AB. All rights reserved.</li>
  </ul>
</div>
</body>
</html>
