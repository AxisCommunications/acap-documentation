<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>liblarod: Working with dma-buf</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="axis-logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">liblarod
   &#160;<span id="projectnumber">3.2.181-dirty</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Working with dma-buf </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Background</h2>
<p>Some backends in larod have support for DMA (Direct Memory Access) buffers. The idea behind such buffers is to minimize copying of data between buffers when running larod jobs. The way that DMA buffers are handled is up to the backend itself, but does in general cause an increase in performance; refer to preprocessing.md and nn-inference.md to find out which backends have dma-buf support. For more detailed information about DMA buffers, refer to <a href="https://www.kernel.org/doc/html/latest/driver-api/dma-buf.html">Linux's official documentation</a>.</p>
<p>larod is able to process DMA buffers as either input- or output tensors when running jobs; these are the only two cases where DMA buffers are relevant for larod. This buffer type is identified with <code>LAROD_FD_TYPE_DMA</code> property, which is often specified when creating the buffer.</p>
<h2>Usage</h2>
<p>Even though DMA buffers are faster in general, they introduce more complexity. The owner of the buffer that wants to either read or write to any DMA buffer (with the CPU) <em>must</em> make sure to sync the CPU cache in the right moment.</p>
<p>Note however that if you don't read or write with the CPU, no cache syncing needs to be done. The buffer can therefore just be supplied as is to the larod API. On the other hand, the following steps are required when running a preprocessing or inference job and dealing with DMA buffers when you want to read or write with the CPU:</p>
<ol type="1">
<li>Start CPU access of the input buffer with the <code>ioctl</code> <code>DMA_BUF_IOCTL_SYNC</code>.</li>
<li>Write the desired data to the input buffer, by e.g. using <code>memcpy</code>.</li>
<li>End CPU access of the input buffer with the <code>ioctl</code> <code>DMA_BUF_IOCTL_SYNC</code>. The input buffer is now cache flushed and ready to be processed by larod.</li>
<li>Run the preprocessing- or inference job.</li>
<li>Start CPU access of the output buffer with the <code>ioctl</code> <code>DMA_BUF_IOCTL_SYNC</code>.</li>
<li>Read from the output buffer, by e.g. using <code>memcpy</code>.</li>
<li>End CPU access of the output buffer with the <code>ioctl</code> <code>DMA_BUF_IOCTL_SYNC</code>.</li>
</ol>
<p>The following code snippet shows an example of how to do steps 1-3 in the numbered list above.</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> copyToTensor(<a class="code" href="larod_8h.html#a07d4c60d47a09a1c1508b8f9b8db3783">larodTensor</a>* tensor,</div><div class="line">                    <span class="keywordtype">size_t</span> tensorSz,</div><div class="line">                    uint8_t* data, <span class="keywordtype">size_t</span> dataSz) {</div><div class="line">    uint32_t props = 0;</div><div class="line">    <span class="keywordflow">if</span> (!<a class="code" href="larod_8h.html#a8c09df637e722e72b8a863f70d41d201">larodGetTensorFdProps</a>(tensor, &amp;props, NULL))</div><div class="line">        <span class="keywordflow">return</span> FALSE;</div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> fd = <a class="code" href="larod_8h.html#a3f6b1aa86a4405bf97dd20fac24dc079">larodGetTensorFd</a>(input, NULL);</div><div class="line">    <span class="keywordflow">if</span> (fd &lt; 0)</div><div class="line">        <span class="keywordflow">return</span> FALSE;</div><div class="line"></div><div class="line">    int64_t tensorOffset = <a class="code" href="larod_8h.html#ac62a72676d62614178600c0df3cb0f36">larodGetTensorFdOffset</a>(tensor, NULL);</div><div class="line">    <span class="keywordflow">if</span> (tensorOffset &lt; 0)</div><div class="line">        <span class="keywordflow">return</span> FALSE;</div><div class="line"></div><div class="line">    <span class="keywordtype">void</span>* tensorData = mmap(NULL, tensorSz, PROT_WRITE, MAP_SHARED, fd,</div><div class="line">                            (off_t) tensorOffset);</div><div class="line">    <span class="keywordflow">if</span> (data == (<span class="keywordtype">void</span>*) MAP_FAILED)</div><div class="line">        <span class="keywordflow">return</span> FALSE;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (props &amp; <a class="code" href="larod_8h.html#aed39dcc2a34acafda2bd771da3ebfc31">LAROD_FD_PROP_DMABUF</a>) {</div><div class="line">        <span class="keyword">struct </span>dma_buf_sync sync;</div><div class="line">        memset(&amp;sync, 0, <span class="keyword">sizeof</span>(sync));</div><div class="line">        sync.flags = DMA_BUF_SYNC_START | DMA_BUF_SYNC_WRITE;</div><div class="line"></div><div class="line">        <span class="keywordtype">int</span> tries = 5;</div><div class="line">        <span class="keywordtype">int</span> ret = -1;</div><div class="line">        <span class="keywordflow">do</span> {</div><div class="line">            ret = ioctl(fd, DMA_BUF_IOCTL_SYNC, &amp;sync);</div><div class="line">        } <span class="keywordflow">while</span> (--tries &gt; 0 &amp;&amp; ret == -1</div><div class="line">                    &amp;&amp; (errno == EAGAIN || errno == EINTR));</div><div class="line">        <span class="keywordflow">if</span> (ret)</div><div class="line">            <span class="keywordflow">return</span> FALSE;</div><div class="line">    }</div><div class="line"></div><div class="line">    memcpy(tensorData, data, (dataSz &lt;= tensorSz) ? dataSz : tensorSz);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (props &amp; LAROD_FD_PROP_DMABUF) {</div><div class="line">        <span class="keyword">struct </span>dma_buf_sync sync;</div><div class="line">        memset(&amp;sync, 0, <span class="keyword">sizeof</span>(sync));</div><div class="line">        sync.flags = DMA_BUF_SYNC_END | DMA_BUF_SYNC_WRITE;</div><div class="line"></div><div class="line">        <span class="keywordtype">int</span> tries = 5;</div><div class="line">        <span class="keywordtype">int</span> ret = -1;</div><div class="line">        <span class="keywordflow">do</span> {</div><div class="line">            ret = ioctl(fd, DMA_BUF_IOCTL_SYNC, &amp;sync);</div><div class="line">        } <span class="keywordflow">while</span> (--tries &gt; 0 &amp;&amp; ret == -1</div><div class="line">                    &amp;&amp; (errno == EAGAIN || errno == EINTR));</div><div class="line">        <span class="keywordflow">if</span> (ret)</div><div class="line">            <span class="keywordflow">return</span> FALSE;</div><div class="line">    }</div><div class="line"></div><div class="line">    munmap(data, tensorSz);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> TRUE;</div><div class="line">}</div></div><!-- fragment --><h2>Internal CPU access</h2>
<p>For some backends larod will internally start a CPU access requiring a DMA sync. However some applications run multiple jobs on the same input tensor without modifying the data. In that case it's only necessary to do a DMA sync for the first job. An application can use the <code>larodMap</code> parameter when creating a job request to specify that the internal DMA sync should be skipped.</p>
<p>Parameter: <code>skip-input-dma-sync</code> (type: <code>LAROD_MAP_TYPE_INT64</code>) Parameter: <code>skip-output-dma-sync</code> (type: <code>LAROD_MAP_TYPE_INT64</code>)</p>
<p>The value is a bit mask with one bit per input tensor. Setting a bit to '1' will tell larod to skip DMA sync for that tensor. The least significant bit corresponds to the tensor with index 0. For example, the following code will skip DMA sync when accessing the underlying buffer for tensor 0 and 2 (but not tensor 1), since 5 is 101 in binary.</p>
<div class="fragment"><div class="line"><a class="code" href="larod_8h.html#a480ba7618e79ad250c166c52d216ab79">larodMap</a>* params = <a class="code" href="larod_8h.html#ac7cb26c7b2ef5c99507edd44e7727b0e">larodCreateMap</a>(error);</div><div class="line"><a class="code" href="larod_8h.html#a0fa6996b2c4518e7b67527ab646a9a2e">larodMapSetInt</a>(params, <span class="stringliteral">&quot;skip-input-dma-sync&quot;</span>, 5, error);</div><div class="line"><a class="code" href="larod_8h.html#a8f6f0898b3a3c25a07582687b6095265">larodJobRequest</a>* req = <a class="code" href="larod_8h.html#af25e0293b11b12fb8e296fb20c828159">larodCreateJobRequest</a>(model, inputTensors, 3,</div><div class="line">                                             outputTensors, 1, params, error);</div></div><!-- fragment --><p>For information about which backends this applies to see the documentation for inference and preprocessing. </p>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Copyright &copy; 2009-2024 Axis Communications AB. All rights reserved.
</small></address>
</body>
</html>
