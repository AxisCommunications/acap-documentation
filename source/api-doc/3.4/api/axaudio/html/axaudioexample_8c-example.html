<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AXaudio: axaudioexample.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="axis-logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AXaudio
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('axaudioexample_8c-example.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">axaudioexample.c</div>  </div>
</div><!--header-->
<div class="contents">
<p><a class="el" href="axaudioexample_8c-example.html">axaudioexample.c</a></p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;axsdk/axaudio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;syslog.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;glib/gstdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;gio/gio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;math.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define APP_NAME &quot;audioApp&quot;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">static</span> GMainLoop *loop = NULL;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>_ExampleData {</div><div class="line">  <a name="_a0"></a><a class="code" href="struct__AXAudioStream.html">AXAudioStream</a> *stream;</div><div class="line">  GFileOutputStream *output_stream;</div><div class="line">  guint totalbytes;</div><div class="line">  guint frames_received;</div><div class="line">  GQueue *frame_queue;</div><div class="line">  GMutex lock;</div><div class="line">  guint64 timestamp;</div><div class="line">} ExampleData;</div><div class="line"></div><div class="line"><span class="comment">/* Signals handling */</span></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line">handle_sigterm(<span class="keywordtype">int</span> signo)</div><div class="line">{</div><div class="line">  g_main_loop_quit(loop);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div><div class="line">init_signals(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">  <span class="keyword">struct </span>sigaction sa;</div><div class="line"></div><div class="line">  sa.sa_flags = 0;</div><div class="line"></div><div class="line">  sigemptyset(&amp;sa.sa_mask);</div><div class="line">  sa.sa_handler = handle_sigterm;</div><div class="line">  sigaction(SIGTERM, &amp;sa, NULL);</div><div class="line">  sigaction(SIGINT, &amp;sa, NULL);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* This function will get all existing frames in the queue and write to file */</span></div><div class="line"><span class="keyword">static</span> gboolean</div><div class="line">frame_analyzer(gpointer data)</div><div class="line">{</div><div class="line">  ExampleData *example_data = data;</div><div class="line">  <a name="_a1"></a><a class="code" href="struct__AXAudioFrame.html">AXAudioFrame</a> *audio_frame = NULL;</div><div class="line"></div><div class="line">  <span class="keywordflow">do</span> {</div><div class="line">  g_mutex_lock(&amp;example_data-&gt;lock);</div><div class="line">  audio_frame = g_queue_pop_head(example_data-&gt;frame_queue);</div><div class="line">  g_mutex_unlock(&amp;example_data-&gt;lock);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (audio_frame != NULL) {</div><div class="line">      example_data-&gt;timestamp = <a name="a2"></a><a class="code" href="axaudio_8h.html#aeb0ff2af86582ecaec36146e6a70d6cf">ax_audio_frame_get_timestamp</a>(audio_frame);</div><div class="line">      example_data-&gt;totalbytes += <a name="a3"></a><a class="code" href="axaudio_8h.html#aa92ba123bf435678520520245b65383e">ax_audio_frame_get_size</a>(audio_frame);</div><div class="line"></div><div class="line">      <span class="comment">/* write frame to file */</span></div><div class="line">      g_output_stream_write_all((GOutputStream*) example_data-&gt;output_stream,</div><div class="line">                                <a name="a4"></a><a class="code" href="axaudio_8h.html#aaecedb4eb4887a6a91e49f83c1b78ee6">ax_audio_frame_get_data</a>(audio_frame),</div><div class="line">                                <a class="code" href="axaudio_8h.html#aa92ba123bf435678520520245b65383e">ax_audio_frame_get_size</a>(audio_frame), NULL,</div><div class="line">                                NULL, NULL);</div><div class="line"></div><div class="line">      <a name="a5"></a><a class="code" href="axaudio_8h.html#a52aa5e281481c44f5f39d4e00382ed9e">ax_audio_frame_free</a>(audio_frame);</div><div class="line">    }</div><div class="line">  } <span class="keywordflow">while</span> (audio_frame);</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> TRUE;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* This function is run in an separate thread that will get audio frames and</span></div><div class="line"><span class="comment"> * put them into a queue */</span></div><div class="line"><span class="keyword">static</span> gpointer</div><div class="line">frame_retriever(gpointer data)</div><div class="line">{</div><div class="line">  ExampleData *example_data = data;</div><div class="line">  <a class="code" href="struct__AXAudioFrame.html">AXAudioFrame</a> * audio_frame = NULL;</div><div class="line">  GError *error = NULL;</div><div class="line"></div><div class="line">  <span class="keywordflow">while</span> (TRUE) {</div><div class="line">    example_data-&gt;frames_received++;</div><div class="line"></div><div class="line">    <span class="comment">/* read numaudio_frames frames of audio data */</span></div><div class="line">    audio_frame = <a name="a6"></a><a class="code" href="axaudio_8h.html#aad181a4a826abd593e96082f56fadfd2">ax_audio_stream_get_frame</a>(example_data-&gt;stream, &amp;error);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (!audio_frame) {</div><div class="line">      <span class="comment">/* nothing to read, this is an error */</span></div><div class="line">      syslog(LOG_WARNING,</div><div class="line">              <span class="stringliteral">&quot;Failed to get audio frame got error code: %d and error message: %s&quot;</span>,</div><div class="line">              error-&gt;code, error-&gt;message);</div><div class="line">      g_error_free(error);</div><div class="line">      <span class="keywordflow">return</span> NULL;</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">      <span class="comment">/* add frame to queue */</span></div><div class="line">      g_mutex_lock(&amp;example_data-&gt;lock);</div><div class="line">      g_queue_push_tail(example_data-&gt;frame_queue, audio_frame);</div><div class="line">      g_mutex_unlock(&amp;example_data-&gt;lock);</div><div class="line">    }</div><div class="line">  }</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">static</span> <a class="code" href="struct__AXAudioFrame.html">AXAudioFrame</a> *</div><div class="line">generate_sine(gint length, gint frequency, guint sound_level)</div><div class="line">{</div><div class="line">  guint frame_rate = 16000;</div><div class="line">  guint sample_per_sin =  frame_rate / frequency;</div><div class="line">  <a class="code" href="struct__AXAudioFrame.html">AXAudioFrame</a> *frame = <a name="a7"></a><a class="code" href="axaudio_8h.html#a20c45bdc3c1d7e86ce5d20de7ff171ed">ax_audio_frame_new</a>();</div><div class="line">  gint16 *data = g_malloc0(<span class="keyword">sizeof</span>(gint16) * frame_rate * length);</div><div class="line">  gint i = 0;</div><div class="line"></div><div class="line">  <span class="keywordflow">for</span> (;i &lt; (frame_rate * length); i++) {</div><div class="line">    data[i] = sin((2 * G_PI / ((sample_per_sin)) * i)) * sound_level;</div><div class="line">  }</div><div class="line">  <a name="a8"></a><a class="code" href="axaudio_8h.html#a3eafd69ed5b68a5dc198c950fe771513">ax_audio_frame_set_data</a>(frame, (gpointer)data, <span class="keyword">sizeof</span>(gint16)* frame_rate * length, (GFreeFunc)&amp;g_free, NULL);</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> frame;</div><div class="line">}</div><div class="line"></div><div class="line">gint</div><div class="line">main(gint argc, gchar *argv[])</div><div class="line">{</div><div class="line">  GError *error = NULL;</div><div class="line">  <a class="code" href="struct__AXAudioStream.html">AXAudioStream</a> * stream = NULL;</div><div class="line">  ExampleData *example_data = NULL;</div><div class="line">  GFile *file = NULL;</div><div class="line">  GFileOutputStream *output_stream = NULL;</div><div class="line">  guint analyser_source_id;</div><div class="line">  GThread *frame_th = NULL;</div><div class="line">  <a class="code" href="struct__AXAudioFrame.html">AXAudioFrame</a> *frame = NULL;</div><div class="line">  <a name="_a9"></a><a class="code" href="struct__AXAudioOutput.html">AXAudioOutput</a> *output = NULL;</div><div class="line"></div><div class="line"><span class="preprocessor">#if !GLIB_CHECK_VERSION(2,36,0)</span></div><div class="line">  g_type_init();</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">  init_signals();</div><div class="line">  loop = g_main_loop_new(NULL, FALSE);</div><div class="line"></div><div class="line">  openlog(APP_NAME, LOG_PID, LOG_LOCAL4);</div><div class="line"></div><div class="line">  syslog(LOG_INFO, <span class="stringliteral">&quot;Starting %s&quot;</span>, APP_NAME);</div><div class="line"></div><div class="line">  <span class="comment">/* play a generated tone of 400 Hz for 2 seconds */</span></div><div class="line">  frame = generate_sine(2, 400, 15000);</div><div class="line"></div><div class="line">  output = <a name="a10"></a><a class="code" href="axaudio_8h.html#aa528bf699ad7b06a36196f215917bf25">ax_audio_open_output_pcm_16</a>(-1, 16000, <a name="a11"></a><a class="code" href="axaudio_8h.html#a3d1b1fb4e67a7718395909ec52a83fe2a35df979f38e10f5139aad903474cee4e">AX_AUDIO_CHANNEL_MONO</a>, &amp;error);</div><div class="line">  <span class="keywordflow">if</span> (output == NULL) {</div><div class="line">    syslog(LOG_WARNING, <span class="stringliteral">&quot;Failed to open playback, code: %d and error message: %s&quot;</span>,</div><div class="line">           error-&gt;code, error-&gt;message);</div><div class="line">    <span class="keywordflow">goto</span> error_out;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keywordflow">if</span> (!<a name="a12"></a><a class="code" href="axaudio_8h.html#ae4cae7985ad38ba4da684d386c599180">ax_audio_output_play_pcm_16</a>(output, frame, &amp;error)) {</div><div class="line">    syslog(LOG_WARNING, <span class="stringliteral">&quot;Failed to play, code: %d and error message: %s&quot;</span>,</div><div class="line">            error-&gt;code, error-&gt;message);</div><div class="line">    <span class="keywordflow">goto</span> error_out;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keywordflow">if</span> (!<a name="a13"></a><a class="code" href="axaudio_8h.html#a05db2571b43d56e22fcc165e6f7f8790">ax_audio_output_close_pcm_16</a>(output, &amp;error)) {</div><div class="line">    syslog(LOG_WARNING, <span class="stringliteral">&quot;Failed to close playback, code: %d and error message: %s&quot;</span>,</div><div class="line">            error-&gt;code, error-&gt;message);</div><div class="line">    <span class="keywordflow">goto</span> error_out;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">/* open up a raw audio stream */</span></div><div class="line">  stream = <a name="a14"></a><a class="code" href="axaudio_8h.html#a9f401a9ff9cbb03a9916cbf86ade1d33">ax_audio_open_pcm_16_stream</a>(1, 16000, <a class="code" href="axaudio_8h.html#a3d1b1fb4e67a7718395909ec52a83fe2a35df979f38e10f5139aad903474cee4e">AX_AUDIO_CHANNEL_MONO</a>, &amp;error);</div><div class="line">  <span class="keywordflow">if</span> (stream == NULL) {</div><div class="line">    syslog(LOG_WARNING, <span class="stringliteral">&quot;Failed with error code: %d and error message: %s&quot;</span>,</div><div class="line">            error-&gt;code, error-&gt;message);</div><div class="line">    <span class="keywordflow">goto</span> error_out;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">/* setting up for saving stream to file */</span></div><div class="line">  file = g_file_new_for_path(<span class="stringliteral">&quot;/tmp/raw_audio.raw&quot;</span>);</div><div class="line">  output_stream = g_file_replace(file, NULL, FALSE, G_FILE_CREATE_NONE, NULL,</div><div class="line">                                 NULL);</div><div class="line"></div><div class="line">  syslog(LOG_INFO,</div><div class="line">          <span class="stringliteral">&quot;RAW audio stream with bit depth: %d and samplerate: %d is setup&quot;</span>,</div><div class="line">          <a name="a15"></a><a class="code" href="axaudio_8h.html#a7fd64c4fa6c3329535fd0a5545aed085">ax_audio_stream_get_bit_depth</a>(stream),</div><div class="line">          <a name="a16"></a><a class="code" href="axaudio_8h.html#a6ad9957652d849fe9f339e9930cef6a3">ax_audio_stream_get_samplerate</a>(stream));</div><div class="line"></div><div class="line">  <span class="comment">/* initialize data structure */</span></div><div class="line">  example_data = g_malloc(<span class="keyword">sizeof</span> *example_data);</div><div class="line">  example_data-&gt;stream = stream;</div><div class="line">  example_data-&gt;output_stream = output_stream;</div><div class="line">  example_data-&gt;frames_received = 0;</div><div class="line">  example_data-&gt;totalbytes = 0;</div><div class="line">  example_data-&gt;frame_queue = g_queue_new();</div><div class="line">  g_mutex_init(&amp;example_data-&gt;lock);</div><div class="line"></div><div class="line">  <span class="comment">/* start a timeout source that will analyze audio frames each 500 ms */</span></div><div class="line">  analyser_source_id = g_timeout_add(500, frame_analyzer, example_data);</div><div class="line"></div><div class="line">  <span class="comment">/* start a threads that retrieves audio frames */</span></div><div class="line">  frame_th = g_thread_new(<span class="stringliteral">&quot;frame retriver&quot;</span>, frame_retriever, example_data);</div><div class="line"></div><div class="line">  <span class="comment">/* start the main loop */</span></div><div class="line">  g_main_loop_run(loop);</div><div class="line"></div><div class="line">  syslog(LOG_INFO,</div><div class="line">         <span class="stringliteral">&quot;Totally %d bytes of audio data was received by %s. The timestamp &quot;</span></div><div class="line">         <span class="stringliteral">&quot;of the latest retrived frame was: %&quot;</span> G_GUINT64_FORMAT <span class="stringliteral">&quot;\n&quot;</span>,</div><div class="line">         example_data-&gt;totalbytes, APP_NAME, example_data-&gt;timestamp);</div><div class="line"></div><div class="line"></div><div class="line">  <span class="comment">/* close analyzer source */</span></div><div class="line">  g_source_remove(analyser_source_id);</div><div class="line"></div><div class="line">  <span class="comment">/* unref the main loop when the main loop has been quit */</span></div><div class="line">  g_main_loop_unref(loop);</div><div class="line"></div><div class="line">  g_thread_unref(frame_th);</div><div class="line"></div><div class="line">  <span class="comment">/* free */</span></div><div class="line">  g_output_stream_close((GOutputStream*) output_stream, NULL, NULL);</div><div class="line">  g_object_unref(output_stream);</div><div class="line">  g_mutex_clear(&amp;example_data-&gt;lock);</div><div class="line">  g_queue_free(example_data-&gt;frame_queue);</div><div class="line">  g_free(example_data);</div><div class="line"></div><div class="line">  error_out:</div><div class="line"></div><div class="line">  <span class="keywordflow">if</span> (error != NULL) {</div><div class="line">    g_error_free(error);</div><div class="line">  }</div><div class="line">  <span class="keywordflow">if</span> (frame != NULL) {</div><div class="line">    <a class="code" href="axaudio_8h.html#a52aa5e281481c44f5f39d4e00382ed9e">ax_audio_frame_free</a>(frame);</div><div class="line">  }</div><div class="line"></div><div class="line">  <a name="a17"></a><a class="code" href="axaudio_8h.html#a3976aa45e5bc65a50fecded95affde6a">ax_audio_stream_close</a>(stream, NULL);</div><div class="line">  syslog(LOG_INFO, <span class="stringliteral">&quot;Quitting %s&quot;</span>, APP_NAME);</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Copyright &copy; 2009-2021 Axis Communications AB. All rights reserved.</li>
  </ul>
</div>
</body>
</html>
